# Workloads Quickstart Guide

**Workload** is a high-level abstraction describing application(s) and/or service(s) that provides business value.
Workload is self-contained.

Workloads are configured under CG DevX installation GitOps repository, and then managed by the team owning the Workload.

CG DevX goal is
to provide isolation on Workload level through all the core services provided by CG DevX platform.

Workload is divided into the following logical blocks:

- **Source code** - code of service(s) workload consists of
- **K8s manifests** all the manifests required to run workload on K8s
- **IaC** describing additional out of the cluster resources required by workload. When using Crossplane, CRDs should be
  merged with K8s manifests.

Those blocks could be all part of one repository or belong to different repositories, depending on user requirements.

To provide better isolation of concerns, it was decided to provide two repositories by default,
one containing source code, and other manifests + IaC.
When a user wants to use different schema, workloads should be created manually,
or repository structure should be adjusted after the workload bootstrap.
Bootstrap templates are designed in a way that allows a user to simply blend them or split GitOps repository in two.

## Prerequisites

- Up and running CG DevX cluster.
  Workloads are defined in CG DevX platform GitOps repository.
  All the operations with workloads should be done from the same machine used CG DevX cluster provisioning,
  as there is a hard dependency on the output of CG DevX setup flow.

- There should be no other ongoing changes (active PRs) in CG DevX platform GitOps repository. This is required to avoid
  inconsistency in infrastructure state.

## Workloads management

### Create

Workload configuration is generated by `workload create` [command](../workload_management/cli_commands.md#create).
This will create a new feature branch in CG DevX platform GitOps repository,
push all the required configurations, and open a pull request (PR).

You as a user should review a PR and apply the changes via PR automation solution
([Atlantis](https://www.runatlantis.io/)).
You could get more details on Atlantis commands [here](https://www.runatlantis.io/docs/using-atlantis.html).

This will create new repositories for your Workload under your Git organizations.
By default, CG DevX will create two repositories,
one for Workload application(s)/service(s) source code,
and another for manifests + environment definitions, and Infrastructure as Code (IaC).
This is done to provide better isolation and access control,
and could be changed by updating Workload configuration for VCS module.
For instance, you may want to use one repo per application(s)/service(s)
instead of using monorepo that is CG DevX default behavior.

You could delete Workload by running `workload delete` [command](../workload_management/cli_commands.md#delete).
This will reverse the changes done by `workload create` command, and open a PR to apply them.

> **Note!**: You must create and delete workloads one by one to avoid conflicts.

### Bootstrap

When PR opened by `workload create` command is merged and closed,
you could bootstrap Workload repositories
with `workload bootstrap` [command](../workload_management/cli_commands.md#bootstrap)
This will provide the following features based on templates created by CG DevX team:

- pre-defined folder structure
- environments definition (dev, sta, prod environments)
- IaC templates
- CI/CD process for Workload application(s)/service(s)
- IaC PR automation configuration

> **Note!**: Reference implementation of delivery pipelines, repository structure,
> manifest and environments definitions are given as examples of platform capabilities.
> They should and must be adjusted for your specific use case before production use.

The following templates are used by default:

- Workload template [repository](https://github.com/CloudGeometry/cg-devx-wl-template)
- Workload GitOps template [repository](https://github.com/CloudGeometry/cg-devx-wl-gitops-template)

After uploading parametrized repo templates, `workload bootstrap` process will create a PR under your Workload GitOps
repository to initialize secrets, and create IAM role for the Workload service.

Your new workload will have a pre-built CI process triggered by a tag applied to workload source code repository.
[Semantic versioning](https://semver.org/) is used.
CI will build an image (images when you have more than one service in your monorepo)
and upload them to the CG DevX image registry ([Harbor](https://goharbor.io/)).
After that,
it will update the image version of Workload service in K8s deployment definitions in Workload GitOps repository
to trigger CD process.
At this point you could promote changes from `dev` environment to other environments
by running promotion action under Workload GitOps repository.

### Manually customizing and managing workloads

On a platform level,
workloads are defined as a set of workload objects that are passed to IaC modules via `terraform.tfvars.json` f
ile ([more here](../platform_management/platform_repo.md#iac)).

In order to create additional workloads, or workload repositories, or manage repository settings you need to
update `terraform.tfvars.json`.

Workloads variable schema is the following

```terraform
variable "workloads" {
  description = "workloads configuration"
  type        = map(object({
    description = optional(string, "")
    repos       = map(object({
      description            = optional(string, "")
      visibility             = optional(string, "private")
      auto_init              = optional(bool, false)
      archive_on_destroy     = optional(bool, false)
      has_issues             = optional(bool, false)
      default_branch_name    = optional(string, "main")
      delete_branch_on_merge = optional(bool, true)
      branch_protection      = optional(bool, true)
      atlantis_enabled       = optional(bool, false)
    }))
  }))
  default = {}
}
```

Workloads are managed and discovered by ArgoCD automatically using the ApplicationSet.
located at `/gitops-pipelines/delivery/clusters/cc-cluster/core-services/200-wl-argocd.yaml`
It monitors `/gitops-pipelines/delivery/clusters/cc-cluster/workloads` path for CC cluster.
Per-workload definitions are based on a template
file [workload-template.yaml](https://github.com/CloudGeometry/cg-devx-core/blob/main/platform/gitops-pipelines/delivery/clusters/cc-cluster/workloads/workload-template.yaml)
and added to that path by CLI.
When manually adding workloads, you should either define your own workload ApplicationSet based on template
and put it into the workloads folder, or create a new ArgoCD application.

